pro make_energy_sav

tic
;;restore data sav files
restore, '/disk/solar3/jsr2/Data/SDO/iris-16-03-15.sav'
restore, '/disk/solar3/jsr2/Data/SDO/sp2826-Apr28-2015.sav'
;restore, '/disk/solar3/jsr2/Data/SDO/hmi-12-05-15.sav'
restore, '/disk/solar3/jsr2/Data/SDO/HMI-diff-15-Oct-15.sav'

;;date string
d1 = strcompress(strmid(systime(),4,7),/remove_all)
d2 = strcompress(strmid(systime(),20),/remove_all)
date = d1+'-'+d2


;;directories
dir = '/disk/solar3/jsr2/Data/SDO/DATA-ANALYSIS/plots/'
datdir = '/disk/solar3/jsr2/Data/SDO/DATA-ANALYSIS/Dat/'


;;;;high intensity pixel coordinate files
fmg = findfile(datdir+'*mgii-high*')
fmgw = findfile(datdir+'*mgiiw-high*')
fsi = findfile(datdir+'*siiv-high*')
;fsp = iris_files('/disk/solar3/jsr2/Data/IRIS/*raster*.fits')
fsp = findfile('/disk/solar3/jsr2/Data/IRIS/*raster*.fits')
;ffsp = findfile(datdir+'*balmer-high*')
ff = findfile(datdir+'hmi-high*')

sample = 1



nmg = n_elements(submg) ;nmg = n_elements(submg[17:*])
nmgw = n_elements(diff2832)
nsi = n_elements(map1400) ;nsi = n_elements(map1400[387:*])
nn = n_elements(fsp)
nnn = n_elements(diff)
nrb = 20 ; number of ribbon sample points
nc = nrb/2
;qkirxa = 519.
;qkirya = 262.

;qkmgxp = 588 
;qkmgyp = 441 
;rbmgxp = 504 
;rbmgyp = 487 

;qksixp = 588 
;qksiyp = 441 
;rbsixp = 511 
;rbsiyp = 485 

;SDO HMI;;;;;;;;;;;;; 
;;;;;;;;;;;;;;;;;;;;;
;quake position
qkxa = 517.2
qkya = 261.4
qkxp = convert_coord_hmi(qkxa, diffindex[63],  /x, /a2p)
qkyp = convert_coord_hmi(qkya, diffindex[63],  /y, /a2p)
qksixp = convert_coord_iris(qkxa, sji_1400_hdr[498], /x, /a2p)
qksiyp = convert_coord_iris(qkya, sji_1400_hdr[498], /y, /a2p)
qkmgxp = convert_coord_iris(qkxa, sji_2796_hdr[664], /x, /a2p)
qkmgyp = convert_coord_iris(qkya, sji_2796_hdr[664], /y, /a2p)
qkmgwxp = convert_coord_iris(qkxa, sji_2832_hdr[167], /x, /a2p)
qkmgwyp = convert_coord_iris(qkya, sji_2832_hdr[167], /y, /a2p)
print, 'flag11111111111111111111111111111111111111111111111111'
dataset = ['si', 'mg', 'balmer', 'mgw', 'hmi']
ncst = string(nc, format = '(I0)')
for i = 1,2 do begin
    ii = string(i, format = '(I0)')
    for k = 0, n_elements(dataset)-1 do begin
        flnm = dataset[k]+'coords'+ii+'.txt' ;flnm=hmicoords1.txt
        openr, lun, flnm, /get_lun
        nlin =  file_lines(flnm)
        tmp = fltarr(2, nlin)
        readf, lun, tmp
        com = dataset[k]+'coords'+ii+ '= tmp' ;readf,lun,hmg
        exe = execute(com)
        free_lun, lun
    endfor
endfor
print, 'flag222222222222222222222222222222222222222222222222'
    ;;;first frame at 17:45:31 or diff[62]
;;;coords1[*,0:4] = south ribbon 
;;;coords1[*,5:9] = north ribbon
dataset = ['si', 'mg', 'mgw', 'hmi']
for k = 0, n_elements(dataset)-1 do begin
    for i = 0, nrb-1 do begin
        ii = string(i, format = '(I0)')
        if (i lt 10) then begin

            if (k eq 0) then begin
                map = 'sji_1400_hdr[495]' 
                com = 'xp = convert_coord_iris('+dataset[k]+'coords1[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_iris('+dataset[k]+'coords1[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)

            endif

            if (k eq 1) then begin
                map = 'sji_2796_hdr[661]'
               com = 'xp = convert_coord_iris('+dataset[k]+'coords1[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_iris('+dataset[k]+'coords1[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)

            endif
;            if (k eq 2) then map = '172' else $
            if (k eq 2) then begin
                map = 'sji_2832_hdr[166]'
               com = 'xp = convert_coord_iris('+dataset[k]+'coords1[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_iris('+dataset[k]+'coords1[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)

            endif

            if (k eq 3) then begin
                map = 'diffindex[62]'
                com = 'xp = convert_coord_hmi('+dataset[k]+'coords1[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_hmi('+dataset[k]+'coords1[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)            
                print, 'flag3333333333333333333333333333333333333333333333333333333'
            endif
        endif 
        if (i gt 9) then begin
            if (k eq 0) then begin
                map = 'sji_1400_hdr[498]'
               com = 'xp = convert_coord_iris('+dataset[k]+'coords2[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_iris('+dataset[k]+'coords2[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)
            endif
            if (k eq 1) then begin
                map = 'sji_2796_hdr[666]'
               com = 'xp = convert_coord_iris('+dataset[k]+'coords2[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_iris('+dataset[k]+'coords2[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)
            endif
;            if (k eq 2) then map = '173' else $
            if (k eq 2) then begin
                map = 'sji_2832_hdr[167]'
                com = 'xp = convert_coord_iris('+dataset[k]+'coords2[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_iris('+dataset[k]+'coords2[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)
            endif
            if (k eq 3) then begin
                map = 'diffindex[63]'
                com = 'xp = convert_coord_hmi('+dataset[k]+'coords2[0,'+ii+'], '+map+',  /x, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbxp'+ii+' = xp'
                exe = execute(com)
                com = 'yp = convert_coord_hmi('+dataset[k]+'coords2[1,'+ii+'], '+map+',  /y, /a2p)'
                exe = execute(com)
                com = dataset[k]+'rbyp'+ii+' = yp'
                exe = execute(com)
            endif
                print, 'flag444444444444444444444444444444444444444444444444444444444'
        endif
    endfor
endfor
print, 'flag555555555555555555555555555555555555555555555555555555555555'

for j = 0, n_elements(fmg) - 1 do begin
;;;;;;;open files 

openr,lun,fmg[j],/get_lun

;;;count lines in file
nlinesmg = file_lines(fmg[j])

;;;make array to fill with values from the file
hmg=intarr(2,nlinesmg)

;;;read file contents into array
readf,lun,hmg

;;close file and free up file unit number
free_lun, lun
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
openr,lun,fmgw[j],/get_lun

;;;count lines in file
nlinesmgw = file_lines(fmgw[j])

;;;make array to fill with values from the file
hmgw=intarr(2,nlinesmgw)

;;;read file contents into array
readf,lun,hmgw

;;close file and free up file unit number
free_lun, lun
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
openr,lun,fsi[j],/get_lun

;;;count lines in file
nlinessi = file_lines(fsi[j])

;;;make array to fill with values from the file
hsi=intarr(2,nlinessi)

;;;read file contents into array
readf,lun,hsi

;;close file and free up file unit number
free_lun, lun
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
openr,lun,ff[j],/get_lun

;;;count lines in file
nlines = file_lines(ff[j])

;;;make array to fill with values from the file
h=intarr(2,nlines)

;;;read file contents into array
readf,lun,h

;;close file and free up file unit number
free_lun, lun
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


;;;rhessi;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;mgii;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

com = 'boxarrmg'+string(j,format = '(I0)')+' = fltarr(nmg)'
exe = execute(com)
;loop to fill arrays with summed pixel intensity values
for i = 0, nmg-1, 1 do begin
;com = 'boxarrmg'+string(j,format = '(I0)')+'[i] = total(submg[17 + i].data[hmg[0,*],hmg[1,*]]) '
com = 'boxarrmg'+string(j,format = '(I0)')+'[i] = total(submg[i].data[hmg[0,*],hmg[1,*]]) '
exe = execute(com)
endfor
;;;flux and energy of flare area
com = 'iris_radiometric_calibration,boxarrmg'+string(j,format = '(I0)')+ $
', wave = 2796, n_pixels = nlinesmg ,F_area_mgii'+string(j,format = '(I0)')+ $
', E_area_mgii'+string(j,format = '(I0)')+' ,/sji'
exe = execute(com)

;;;balmer;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;	for i = 0, nn-1, 1 do begin
;		comt = 'timearr[i] = sp2826.'+tagarr[i]+'.time_ccsds[3]'
;		exet1 = execute(comt)
;		comi = 'spboxarr[i] = total(sp2826.'+tagarr[i]+'.int[39:44,3:4,435])/((44-39)*2)'
;		exet = execute(comi)
;	endfor


;;;mgiiw;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

com = 'boxarrmgw'+string(j,format = '(I0)')+' = fltarr(nmgw)'
exe = execute(com)
;loop to fill arrays with summed pixel intensity values
for i = 0, nmgw-1, 1 do begin
com = 'boxarrmgw'+string(j,format = '(I0)')+'[i] = total(diff2832[i].data[hmgw[0,*],hmgw[1,*]])
exe = execute(com)
endfor
;;;flux and energy of flare area
com = 'iris_radiometric_calibration,boxarrmgw'+string(j,format = '(I0)')+ $
', wave = 2832, n_pixels = nlinesmgw ,F_area_mgiiw'+string(j,format = '(I0)')+ $
', E_area_mgiiw'+string(j,format = '(I0)')+' ,/sji'
exe = execute(com)


;;siiv;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;501?

com = 'boxarrsi'+string(j,format = '(I0)')+' = fltarr(nsi)'
exe = execute(com)
;loop to fill arrays with summed pixel intensity values
for i = 0, nsi-1, 1 do begin
;com = 'boxarrsi'+string(j,format = '(I0)')+'[i] = total(map1400[387 + i].data[hsi[0,*],hsi[1,*]]) '
com = 'boxarrsi'+string(j,format = '(I0)')+'[i] = total(map1400[i].data[hsi[0,*],hsi[1,*]]) '
exe = execute(com)
endfor
;;;flux and energy of flare area
com = 'iris_radiometric_calibration, boxarrsi'+string(j,format = '(I0)')+ $
', wave = 1400, n_pixels = nlinessi , F_area_siiv'+string(j,format = '(I0)')+ $
', E_area_siiv'+string(j,format = '(I0)')+' ,/sji'

exe = execute(com)

;;hmi continuum;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
com = 'boxarr'+string(j,format = '(I0)')+' = fltarr(nnn)'
exe = execute(com)
;bgarr = fltarr(nnn)
for i = 0, nnn-1, 1 do begin
com = 'boxarr'+string(j,format = '(I0)')+'[i] = total(diff[i].data[h[0,*],h[1,*]])'
exe = execute(com) 
endfor
;;;;;intensity of flare area in erg/s.cm^2.sr
com = 'hmi_radiometric_calibration, boxarr'+string(j,format = '(I0)')+ $
', n_pixels = nlines, F_area_hmi'+string(j,format = '(I0)')+ $
', E_area_hmi'+string(j,format = '(I0)')+''
exe = execute(com)
endfor

;;;set up single pixel arrays
qkmg = fltarr(nmg)
qkmgw = fltarr(nmgw)
qksi = fltarr(nsi)
qkbalmer = fltarr(sample*nn)
tspqk = strarr(sample*nn)
qkhmi = fltarr(nnn)


slitpos = strarr(nn)
spypos = strarr(nn)
qkslitpos = strarr(nn)
qkspypos = strarr(nn)

;;qk and multi-ribbon coord max flux and energy

sifmxqk = fltarr(2,3)
siemxqk = fltarr(2,3)
sifmx = fltarr(3,nrb) ;fmx[0,*] = time, fmx[1,*] = max
siemx = fltarr(3,nrb)

mgfmxqk = fltarr(2,3)
mgemxqk = fltarr(2,3)
mgfmx = fltarr(3,nrb) ;fmx[0,*] = time, fmx[1,*] = max
mgemx = fltarr(3,nrb)

balmerfmxqk = fltarr(2,3)
balmeremxqk = fltarr(2,3)
balmerfmx = fltarr(3,nrb) ;fmx[0,*] = time, fmx[1,*] = max
balmeremx = fltarr(3,nrb)


mgwfmxqk = fltarr(2,3)
mgwemxqk = fltarr(2,3)
mgwfmx = fltarr(3,nrb) ;fmx[0,*] = time, fmx[1,*] = max
mgwemx = fltarr(3,nrb)

hmifmxqk = fltarr(2,3)
hmimxqk = fltarr(2,3)
hmifmx = fltarr(3,nrb) ;fmx[0,*] = time, fmx[1,*] = max
hmiemx = fltarr(3,nrb)


;;;make time arrays
tsi = map1400.time
tmg = submg.time
tmgw = map2832.time
thmi = diff.time
print, 'flag6666666666666666666666666666666666666666666666666666666666'

for j = 0, nrb-1 do begin
jj = string(j, format = '(I0)')

com = 'rbsi'+jj+' = fltarr(nsi)'
exe = execute(com)
com = 'rbmg'+jj+' = fltarr(nmg)'
exe = execute(com)
com = 'rbbalmer'+jj+' = fltarr(sample*nn)'
exe = execute(com)
com = 'rbmgw'+jj+' = fltarr(nmgw)'
exe = execute(com)
com = 'tsprb'+jj+' = strarr(sample*nn)'
exe = execute(com)
com = 'rbhmi'+jj+' = fltarr(nnn)'
exe = execute(com)

;;;;;;;;;FILL ARRAYS
print, 'flag7777777777777777777777777777777777777777777777777777777777777'
    ;;SI IV 1400
    for i = 0, nsi-1, 1 do begin
        if (j eq 19) then begin
        qksi[i] = map1400[i].data[qksixp, qksiyp]
        endif
    com = 'rbsi'+jj+'[i] = map1400[i].data[sirbxp'+jj+', sirbyp'+jj+']'
    exe = execute(com)
    endfor
    ;calculate flux and energy
        if (j eq 19) then begin
        iris_radiometric_calibration, qksi, wave = 1400., n_pixels = 1, Fsiqk, Esiqk, /sji                     
        endif    
    com = 'iris_radiometric_calibration, rbsi'+jj+', wave = 1400., n_pixels = 1,Fsirb'+jj+', Esirb'+jj+', /sji'
    exe = execute(com)
print, 'flag888888888888888888888888888888888888888888888888888888888888888'


    ;;MG II 2796
    for i = 0, nmg-1, 1 do begin
        if (j eq 19) then begin
        qkmg[i] = submg[i].data[qkmgxp, qkmgyp] ;qkmg[i] = submg[17 + i].data[qkmgxp, qkmgyp]
        endif
    com = 'rbmg'+jj+'[i] = submg[i].data[mgrbxp'+jj+', mgrbyp'+jj+']' 
    exe = execute(com)
    endfor
        if (j eq 19) then begin
        ;calculate flux and energy
        iris_radiometric_calibration, qkmg, wave = 2976., n_pixels = 1,Fmgqk, Emgqk, /sji                    
        endif
    com = 'iris_radiometric_calibration, rbmg'+jj+', wave = 2976., n_pixels = 1,Fmgrb'+jj+', Emgrb'+jj+', /sji'
    exe = execute(com)
print, 'flag999999999999999999999999999999999999999999999999999999999999999999
    ;;BALMER
    if (j lt 10) then begin
        com = 'slitp = find_iris_slit_pos(balmercoords1[0,'+jj+'],sp2826)'
        exe = execute(com)
        com = 'spyp = find_iris_slit_pos(balmercoords1[0,'+jj+'],sp2826, /y, /a2p)'
        exe = execute(com)

    endif
    if (j gt 9) then begin
        com = 'slitp = find_iris_slit_pos(balmercoords2[0,'+jj+'],sp2826)'
        exe = execute(com)
        com = 'spyp = find_iris_slit_pos(balmercoords2[1,'+jj+'],sp2826, /y, /a2p)'
        exe = execute(com)
    endif
    if (j eq 19) then begin
        com = 'qkslitp = find_iris_slit_pos(qkxa,sp2826)'
        exe = execute(com)
        com = 'qkspyp = find_iris_slit_pos(qkya,sp2826, /y, /a2p)'
        exe = execute(com)
    endif
        for i = 0, nn-1, 1 do begin  
            slitpos = string(slitp[i], format = '(I0)')
            spypos = string(spyp[i], format = '(I0)')

            com = 'rbbalmer'+jj+'[i] = total(sp2826.'+tagarr[i]+'.int[39:44,'+slitpos+','+spypos+'])/((44-39))'
            exe = execute(com)

            com = 'tsprb'+jj+'[i] = sp2826.'+tagarr[i]+'.time_ccsds['+slitpos+']'
            exe = execute(com)
            
            if (j eq 19) then begin
                qkslitpos = string(qkslitp[i], format = '(I0)')
                qkspypos = string(qkspyp[i], format = '(I0)')

                com = 'qkbalmer[i] = total(sp2826.'+tagarr[i]+'.int[39:44,'+qkslitpos+','+qkspypos+'])/((44-39))'
                exe = execute(com)

                com = 'tspqk[i] = sp2826.'+tagarr[i]+'.time_ccsds['+qkslitpos+']'
                exe = execute(com)
            
            endif
        endfor
    ;;calculate flux and energy
    wav1 = sp2826.tag00.wvl[39]
    wav2 = sp2826.tag00.wvl[44]
    w1 = string(wav1, format = '(I0)')
    w2 = string(wav2, format = '(I0)')
        if (j eq 19) then begin
        iris_radiometric_calibration, qkbalmer, wave = [wav1, wav2], n_pixels = 10, Fbalmerqk, Ebalmerqk, /sg
        endif
    com = 'iris_radiometric_calibration,rbbalmer'+jj+',wave=['+w1+','+w2+'],n_pixels=10,Fbalmerrb'+jj+',Ebalmerrb'+jj+',/sg'
    exe = execute(com)

print, 'flag0000000000000000000000000000000000000000000000000000000'



    ;;MGW 2832
    for i = 0, nmgw-1, 1 do begin
        if (j eq 19) then begin
        qkmgw[i] = map2832[i].data[qkmgwxp,qkmgwyp ]  ;559, 441
        endif

    com = 'rbmgw'+jj+'[i] = map2832[i].data[mgwrbxp'+jj+', mgwrbyp'+jj+']'
    exe = execute(com)
    endfor   

    ;calculate flux and energy
        if (j eq 19) then begin
        iris_radiometric_calibration, qkmgw, wave = 2832., n_pixels = 1,Fmgwqk, Emgwqk, /sji                   
        endif

    com = 'iris_radiometric_calibration, rbmgw'+jj+', wave = 2832., n_pixels = 1,Fmgwrb'+jj+', Emgwrb'+jj+', /sji'
    exe = execute(com)



    ;HMI single pixel
    for i = 0, nnn-1, 1 do begin
        if (j eq 19) then begin
        qkhmi[i] = diff[i].data[qkxp, qkyp]
        endif
    com = 'rbhmi'+jj+'[i] = diff[i].data[hmirbxp'+jj+', hmirbyp'+jj+']'
    exe = execute(com)
    endfor

    ;calculate flux and energy
        if (j eq 19) then begin
        hmi_radiometric_calibration, qkhmi, n_pixels = 1, Fhmiqk, Ehmiqk
        endif  
    com = 'hmi_radiometric_calibration, rbhmi'+jj+', n_pixels = 1, Fhmirb'+jj+', Ehmirb'+jj+''
    exe = execute(com)
endfor


for k = 0, n_elements(dataset)-1 do begin
nc = nrb/4
ncst = string(nc, format = '(I0)')
    for j = 0, nrb-1 do begin
        if (j lt 10) then begin
            if (k eq 0) then map = '495' else $
            if (k eq 1) then map = '661' else $
            if (k eq 2) then map = '172' else $
            if (k eq 3) then map = '166' else $
            if (k eq 4) then map = '62'
            com = 'cd = '+dataset[k]+'coords1[0,'+jj+']'
            exe = execute(com)
            
        endif 
        if (j gt 9) then begin
            if (k eq 0) then map = '498' else $
            if (k eq 1) then map = '666' else $
            if (k eq 2) then map = '173' else $
            if (k eq 3) then map = '167' else $
            if (k eq 4) then map = '63'
            com = 'cd = '+dataset[k]+'coords2[0,'+jj+']'
            exe = execute(com)
        endif 
        if (j eq 8) then begin
        ;find maximum flux and energy
        com = 'qkmxf = F'+dataset[k]+'qk['+map+']'
        exe = execute(com)
        com = 'qkmxe = E'+dataset[k]+'qk['+map+']'
        exe = execute(com)

        com = dataset[k]+'fmxqk[0,0] = mp'
        exe = execute(com)
        com = dataset[k]+'fmxqk[0,1] = qkxa'
        exe = execute(com)
        com = dataset[k]+'fmxqk[0,2] = qkmxf'

        com = dataset[k]+'emxqk[0,0] = mp'
        exe = execute(com)
        com = dataset[k]+'emxqk[0,1] = qkxa'
        exe = execute(com)
        com = dataset[k]+'emxqk[0,2] = qkmxe'

        endif

        if (j eq 18) then begin
        ;find maximum flux and energy
        com = 'qkmxf = F'+dataset[k]+'qk['+map+']'
        exe = execute(com)
        com = 'qkmxe = E'+dataset[k]+'qk['+map+']'
        exe = execute(com)

        com = dataset[k]+'fmxqk[1,0] = mp'
        exe = execute(com)
        com = dataset[k]+'fmxqk[1,1] = qkxa'
        exe = execute(com)
        com = dataset[k]+'fmxqk[1,2] = qkmxf'

        com = dataset[k]+'emxqk[1,0] = mp'
        exe = execute(com)
        com = dataset[k]+'emxqk[1,1] = qkxa'
        exe = execute(com)
        com = dataset[k]+'emxqk[1,2] = qkmxe'
        endif

        com = 'mxf = F'+dataset[k]+'rb'+jj+'['+map+']'
        exe = execute(com)
        com = 'mxe = E'+dataset[k]+'rb'+jj+'['+map+']'
        exe = execute(com)
      
        mp = fix(map)
        com = dataset[k]+'fmx[0,'+jj+'] = mp'
        exe = execute(com)
        com = dataset[k]+'fmx[1,'+jj+'] = cd'
        exe = execute(com)
        com = dataset[k]+'fmx[2,'+jj+'] = mxf'
        exe = execute(com)

        com = dataset[k]+'emx[0,'+jj+'] = mp'
        exe = execute(com)
        com = dataset[k]+'emx[1,'+jj+'] = cd'
        exe = execute(com)
        com = dataset[k]+'emx[2,'+jj+'] = mxe'
        exe = execute(com)
    endfor
endfor

;HMI quake area array...eventually calculate iris quake energy based on solid angle relationship found by trumpet.pro
qkarea = fltarr(nnn)
;based on the four iris pixels (4*0.1667") flagged by quake_area.pro.....more detailed version needed
;assuming 2 iris pixels relate to the radius of a circular quake impact, 
;but 0.505/0.1667 = 3 therefore 3 iris pixels equal one hmi pixel, which sets minimum resolution
;iris_quake_radius = 2*(0.1667*7.5e5)  
;iris_quake_area = !pi*quake_radius^2 
for i= 0, nnn-1 do begin
qkarea[i] = diff[i].data[qkxp, qkyp] + $
diff[i].data[qkxp, qkyp + 1] + $
diff[i].data[qkxp - 1, qkyp + 1] + $
diff[i].data[qkxp - 1, qkyp] + $
diff[i].data[qkxp - 1, qkyp - 1] + $
diff[i].data[qkxp, qkyp - 1] + $
diff[i].data[qkxp + 1, qkyp - 1] + $
diff[i].data[qkxp + 1, qkyp] + $
diff[i].data[qkxp + 1, qkyp + 1]
endfor
hmi_radiometric_calibration, qkarea, n_pixels = 9, Fqk_9px_area, Eqk_9px_area



;;;make .sav file
save, $
;iris flare area siiv
F_area_siiv0, E_area_siiv0, $
F_area_siiv1, E_area_siiv1, $
F_area_siiv2, E_area_siiv2, $
F_area_siiv3, E_area_siiv3, $
tsi, $
filename = '29-Mar-2014-energies-iris-siiv-area-'+date+'.sav'

save, $
;iris flare area mgii
F_area_mgii0, E_area_mgii0, $
F_area_mgii1, E_area_mgii1, $
F_area_mgii2, E_area_mgii2, $
F_area_mgii3, E_area_mgii3, $
tmg, $
filename = '29-Mar-2014-energies-iris-mgii-area-'+date+'.sav'

save, $
;iris flare area mgw
F_area_mgiiw0, E_area_mgiiw0, $
F_area_mgiiw1, E_area_mgiiw1, $
F_area_mgiiw2, E_area_mgiiw2, $
F_area_mgiiw3, E_area_mgiiw3, $
tmgw, $
filename = '29-Mar-2014-energies-iris-mgw-area-'+date+'.sav'

save, $
;hmi flare area
F_area_hmi0, E_area_hmi0, $
F_area_hmi1, E_area_hmi1, $
F_area_hmi2, E_area_hmi2, $
F_area_hmi3, E_area_hmi3, $
thmi, $
filename = '29-Mar-2014-energies-hmi-area-'+date+'.sav'

save, $
;siiv; for time use tsi
Fsiqk, Esiqk, $
Fsirb0, Esirb0, $
Fsirb1, Esirb1, $
Fsirb2, Esirb2, $
Fsirb3, Esirb3, $
Fsirb4, Esirb4, $
Fsirb5, Esirb5, $
Fsirb6, Esirb6, $
Fsirb7, Esirb7, $
Fsirb8, Esirb8, $
Fsirb9, Esirb9, $
Fsirb10, Esirb10, $
Fsirb11, Esirb11, $
Fsirb12, Esirb12, $
Fsirb13, Esirb13, $
Fsirb14, Esirb14, $
Fsirb15, Esirb15, $
Fsirb16, Esirb16, $
Fsirb17, Esirb17, $
Fsirb18, Esirb18, $
Fsirb19, Esirb19, $
tsi, $
sicoords1, $
sicoords2, $
sifmxqk, $
sifmx, $
siemxqk, $
siemx, $
filename = '29-Mar-2014-energies-iris-siiv-single-pixel-'+date+'.sav'

save, $
;mgii; for time use tmg
Fmgqk, Emgqk, $
Fmgrb0, Emgrb0, $
Fmgrb1, Emgrb1, $
Fmgrb2, Emgrb2, $
Fmgrb3, Emgrb3, $
Fmgrb4, Emgrb4, $
Fmgrb5, Emgrb5, $
Fmgrb6, Emgrb6, $
Fmgrb7, Emgrb7, $
Fmgrb8, Emgrb8, $
Fmgrb9, Emgrb9, $
Fmgrb10, Emgrb10, $
Fmgrb11, Emgrb11, $
Fmgrb12, Emgrb12, $
Fmgrb13, Emgrb13, $
Fmgrb14, Emgrb14, $
Fmgrb15, Emgrb15, $
Fmgrb16, Emgrb16, $
Fmgrb17, Emgrb17, $
Fmgrb18, Emgrb18, $
Fmgrb19, Emgrb19, $
tmg, $
mgcoords1, $
mgcoords2, $
mgfmxqk, $
mgfmx, $
mgemxqk, $
mgemx, $
filename = '29-Mar-2014-energies-iris-mgii-single-pixel-'+date+'.sav'

save, $
;balmer; for time use timearr
Fqkbalmer, Eqkbalmer, $
Frbbalmer0, Erbbalmer0, $
Frbbalmer1, Erbbalmer1, $
Frbbalmer2, Erbbalmer2, $
Frbbalmer3, Erbbalmer3, $
Frbbalmer4, Erbbalmer4, $
Frbbalmer5, Erbbalmer5, $
Frbbalmer6, Erbbalmer6, $
Frbbalmer7, Erbbalmer7, $
Frbbalmer8, Erbbalmer8, $
Frbbalmer9, Erbbalmer9, $
Frbbalmer10, Erbbalmer10, $
Frbbalmer11, Erbbalmer11, $
Frbbalmer12, Erbbalmer12, $
Frbbalmer13, Erbbalmer13, $
Frbbalmer14, Erbbalmer14, $
Frbbalmer15, Erbbalmer15, $
Frbbalmer16, Erbbalmer16, $
Frbbalmer17, Erbbalmer17, $
Frbbalmer18, Erbbalmer18, $
Frbbalmer19, Erbbalmer19, $
tspqk, $
tsprb0, $
tsprb1, $
tsprb2, $
tsprb3, $
tsprb4, $
tsprb5, $
tsprb6, $
tsprb7, $
tsprb8, $
tsprb9, $
tsprb10, $
tsprb11, $
tsprb12, $
tsprb13, $
tsprb14, $
tsprb15, $
tsprb16, $
tsprb17, $
tsprb18, $
tsprb19, $
balmercoords1, $
balmercoords2, $
balmerfmxqk, $
balmerfmx, $
balmeremxqk, $
balmeremx, $
filename = '29-Mar-2014-energies-iris-balmer-single-pixel-'+date+'.sav'

save, $
;mgw; for time use tmgw
Fmgwqk, Emgwqk, $
Fmgwrb0, Emgwrb0, $
Fmgwrb1, Emgwrb1, $
Fmgwrb2, Emgwrb2, $
Fmgwrb3, Emgwrb3, $
Fmgwrb4, Emgwrb4, $
Fmgwrb5, Emgwrb5, $
Fmgwrb6, Emgwrb6, $
Fmgwrb7, Emgwrb7, $
Fmgwrb8, Emgwrb8, $
Fmgwrb9, Emgwrb9, $
Fmgwrb10, Emgwrb10, $
Fmgwrb11, Emgwrb11, $
Fmgwrb12, Emgwrb12, $
Fmgwrb13, Emgwrb13, $
Fmgwrb14, Emgwrb14, $
Fmgwrb15, Emgwrb15, $
Fmgwrb16, Emgwrb16, $
Fmgwrb17, Emgwrb17, $
Fmgwrb18, Emgwrb18, $
Fmgwrb19, Emgwrb19, $
tmgw, $
mgwcoords1, $
mgwcoords1, $
mgwfmxqk, $
mgwfmx, $
mgwemxqk, $
mgwemx, $
filename = '29-Mar-2014-energies-iris-mgw-single-pixel-'+date+'.sav'

save, $
;hmi; for time use thmi
Fhmiqk, Ehmiqk, $
Fhmirb0, Ehmirb0, $
Fhmirb1, Ehmirb1, $
Fhmirb2, Ehmirb2, $
Fhmirb3, Ehmirb3, $
Fhmirb4, Ehmirb4, $
Fhmirb5, Ehmirb5, $
Fhmirb6, Ehmirb6, $
Fhmirb7, Ehmirb7, $
Fhmirb8, Ehmirb8, $
Fhmirb9, Ehmirb9, $
Fhmirb10, Ehmirb10, $
Fhmirb11, Ehmirb11, $
Fhmirb12, Ehmirb12, $
Fhmirb13, Ehmirb13, $
Fhmirb14, Ehmirb14, $
Fhmirb15, Ehmirb15, $
Fhmirb16, Ehmirb16, $
Fhmirb17, Ehmirb17, $
Fhmirb18, Ehmirb18, $
Fhmirb19, Ehmirb19, $
thmi, $
hmicoords1, $
hmicoords2, $
hmifmxqk, $
hmifmx, $
hmiemxqk, $
hmiemx, $
filename = '29-Mar-2014-energies-hmi-single-pixel-'+date+'.sav'

save, $
;quake area
Fqk_9px_area, Eqk_9px_area, $
thmi, $
filename = '29-Mar-2014-energies-hmi-qkarea-'+date+'.sav'


toc
end
